function doPost(e) {
  try {
    const raw = e.postData?.contents;
    if (!raw) throw new Error("No se recibieron datos (postData vac√≠o).");

    const data = JSON.parse(raw);
    const cliente = data.cliente || {};
    const productos = data.productos || [];

    const ss = SpreadsheetApp.openById("1_e3KhpynZI5jCDn4GBZqXwe-IpZkiE9G1L4CQ7v8HU0");
    const sh = ss.getSheetByName("Pedidos_Auto");
    if (!sh) throw new Error("‚ùå No se encontr√≥ la hoja 'Pedidos_Auto'.");

    const fechaRegistro = Utilities.formatDate(new Date(), "America/Lima", "dd/MM/yyyy HH:mm:ss");

    // --- Crear encabezado si la hoja est√° vac√≠a ---
    if (sh.getLastRow() === 0) {
      sh.appendRow([
        "C√≥digo", "Fecha Registro", "Fecha Entrega", "Cliente", "Producto", "Unidad",
        "Cantidad", "Precio", "Monto", "Descuento", "Monto c/Desc.", "Estado",
        "Debe", "Contacto", "Celular", "Direcci√≥n", "Mapa", "Cierre"
      ]);
    }

    // --- Calcular total del pedido (sumando todos los productos) ---
    const totalPedido = productos.reduce((suma, p) => {
      const cantidad = parseFloat(p.cantidad || 0);
      const precio = parseFloat(p.precio || 0);
      const descuento = parseFloat(p.descuento || 0);
      return suma + (cantidad * precio - descuento);
    }, 0);

    const pagoCliente = parseFloat(cliente.pago || 0);
    const debeTotal = totalPedido - pagoCliente;

    // --- Registrar cada producto ---
    productos.forEach((p, index) => {
      const cantidad = parseFloat(p.cantidad || 0);
      const precio = parseFloat(p.precio || 0);
      const descuento = parseFloat(p.descuento || 0);
      const monto = cantidad * precio;
      const montoDesc = monto - descuento;
      const codigo = "PED-" + Utilities.formatString("%03d", sh.getLastRow() + 1);

      const debe = index === 0 ? debeTotal : "";

      sh.appendRow([
        codigo,
        fechaRegistro,
        cliente.fechaEntrega,
        cliente.nombre,
        p.pedido,
        "", // unidad
        cantidad,
        precio,
        monto,
        descuento,
        montoDesc,
        "0: Por Entregar",
        debe,
        cliente.contacto,
        cliente.celular,
        cliente.direccion,
        cliente.mapa || "", // üåç Guardar el link de Google Maps
        "" // cierre
      ]);
    });

    Logger.log(`‚úÖ Pedido guardado correctamente con ubicaci√≥n. Total: S/ ${totalPedido.toFixed(2)} | Pago: S/ ${pagoCliente} | Debe: S/ ${debeTotal}`);

    return ContentService.createTextOutput(
      JSON.stringify({
        ok: true,
        mensaje: "‚úÖ Pedido guardado correctamente con ubicaci√≥n.",
        total: totalPedido,
        debe: debeTotal,
      })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log("‚ùå Error detectado: " + err.message);
    return ContentService.createTextOutput(
      JSON.stringify({ ok: false, error: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}
